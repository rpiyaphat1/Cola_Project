<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - IEP Smart Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

    <nav class="bg-indigo-900 text-white shadow-lg mb-8 font-sans">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center text-sm font-medium">
            <div class="flex items-center space-x-10">
                <div class="font-bold text-xl uppercase italic tracking-tighter border-r border-indigo-700 pr-10">
                    IEP Smart Assistant
                </div>

                <div class="flex space-x-8">
                    <a href="{{ url_for('chatbot_page') }}"
                        class="{% if request.endpoint == 'chatbot_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">Chatbot AI </a>
                </div>
            </div>

            <div class="relative">
                <button onclick="toggleDropdown()"
                    class="bg-indigo-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition flex items-center shadow-md outline-none">
                    {{ session['displayname'] }} <span class="ml-2 text-[10px]">‚ñº</span>
                </button>
                <div id="user-menu"
                    class="absolute right-0 w-48 mt-2 py-2 bg-white rounded-xl shadow-xl hidden z-50 text-slate-700 border border-slate-100">
                    <a href="{{ url_for('student_list_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
                    <a href="{{ url_for('admin_dashboard') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">Dashboard</a>
                    <a href="{{ url_for('register_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                    <a href="{{ url_for('import_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
                    <a href="{{ url_for('setting_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</a>
                    <hr class="my-1 border-slate-100">
                    <a href="/logout"
                        class="block px-4 py-2 text-sm text-rose-600 font-bold hover:bg-rose-50 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-col items-center justify-center flex-grow px-4 pb-12 space-y-8">

        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-2xl w-full border border-gray-100">
            <h2 class="text-2xl font-extrabold mb-2 text-gray-800 text-center uppercase italic">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå
                (Excel/CSV)</h2>
            <p class="text-gray-400 text-center mb-8 text-sm italic border-b pb-4">
                ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>

            <div class="flex flex-col space-y-4">
                <div
                    class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center bg-gray-50 hover:bg-gray-100 transition-all">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .csv"
                        onchange="handleFile(this.files)">
                    <button onclick="document.getElementById('file-input').click()"
                        class="text-indigo-600 font-bold hover:underline">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                    </button>
                    <p id="file-name" class="text-xs text-gray-500 mt-2 italic font-medium"></p>
                </div>
                <button onclick="startUpload()" id="upload-btn" disabled
                    class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 shadow-lg transform active:scale-95 transition-all opacity-50 cursor-not-allowed uppercase tracking-widest text-sm">
                    ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>
        </div>

        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-2xl w-full border border-gray-100">
            <h2 class="text-2xl font-extrabold mb-2 text-gray-800 text-center uppercase italic">üë§
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</h2>
            <p class="text-gray-400 text-center mb-8 text-sm italic border-b pb-4">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>

            <form id="student-form" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="nickname"
                            class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 shadow-sm transition-all"
                            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="fullname"
                            class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 shadow-sm transition-all"
                            placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">‡∏ä‡∏±‡πâ‡∏ô</label>
                        <select id="grade"
                            class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 font-bold text-sm shadow-sm cursor-pointer"
                            required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô (‡∏õ.1/1 - ‡∏õ.6/17)</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á</label>
                        <select id="disability_type"
                            class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 font-bold text-sm shadow-sm cursor-pointer">
                            <option value="0">0. ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="5">5. ‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (LD)</option>
                            <option value="7">7. ‡∏≠‡∏≠‡∏ó‡∏¥‡∏™‡∏ï‡∏¥‡∏Å</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label
                        class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠/‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞</label>
                    <textarea id="technique" rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 shadow-sm transition-all"
                        placeholder="‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•..."></textarea>
                </div>

                <button type="button" onclick="saveStudent()" id="save-btn"
                    class="w-full bg-blue-600 text-white font-bold py-4 mt-4 rounded-xl hover:bg-blue-700 shadow-lg transform active:scale-95 transition-all uppercase tracking-widest text-sm">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏õ.1/1 - ‡∏õ.6/17 ---
        const gradeSelect = document.getElementById('grade');
        for (let p = 1; p <= 6; p++) {
            for (let room = 1; room <= 17; room++) {
                let opt = document.createElement('option');
                opt.value = `‡∏õ.${p}/${room}`;
                opt.textContent = `‡∏õ.${p}/${room}`;
                gradeSelect.appendChild(opt);
            }
        }

        // --- 2. ‡∏£‡∏∞‡∏ö‡∏ö Dropdown ---
        function toggleDropdown() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
        window.onclick = function (event) {
            if (!event.target.closest('.relative')) {
                const menu = document.getElementById('user-menu');
                if (menu && !menu.classList.contains('hidden')) menu.classList.add('hidden');
            }
        }

        // --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå ---
        let selectedFile = null;
        function handleFile(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                document.getElementById('file-name').innerText = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${selectedFile.name}`;
                const btn = document.getElementById('upload-btn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function startUpload() {
            if (!selectedFile) return;
            const formData = new FormData();
            formData.append('file', selectedFile);
            try {
                const res = await fetch('/api/import_excel', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    alert(result.message);
                    window.location.href = "{{ url_for('student_list_page') }}";
                } else { alert(result.error); }
            } catch (err) { alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á'); }
        }

        // --- 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô ---
        async function saveStudent() {
            const data = {
                nickname: document.getElementById('nickname').value,
                fullname: document.getElementById('fullname').value,
                grade: document.getElementById('grade').value,
                disability_type: document.getElementById('disability_type').value,
                technique: document.getElementById('technique').value
            };
            if (!data.fullname || !data.grade) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

            try {
                const res = await fetch('/api/add_student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert(result.message);
                    document.getElementById('student-form').reset();
                }
            } catch (err) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        }
    </script>
</body>

</html>