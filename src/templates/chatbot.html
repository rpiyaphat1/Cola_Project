<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - IEP Smart Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col font-sans overflow-hidden">

    <nav class="bg-indigo-900 text-white shadow-lg mb-8 font-sans">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center text-sm font-medium">
            <div class="flex items-center space-x-10">
                <div class="font-bold text-xl uppercase italic tracking-tighter border-r border-indigo-700 pr-10">
                    IEP Smart Assistant
                </div>

                <div class="flex space-x-8">
                    <a href="{{ url_for('chatbot_page') }}"
                        class="{% if request.endpoint == 'chatbot_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">Chatbot
                        AI</a>

                </div>
            </div>
            <div class="relative">
                <button onclick="toggleDropdown()"
                    class="bg-indigo-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition flex items-center shadow-md outline-none">
                    {{ session['displayname'] }} <span class="ml-2 text-[10px]">‚ñº</span>
                </button>
                <div id="user-menu"
                    class="absolute right-0 w-48 mt-2 py-2 bg-white rounded-xl shadow-xl hidden z-50 text-slate-700 border border-slate-100">
                    <a href="{{ url_for('student_list_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
                    <a href="{{ url_for('admin_dashboard') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">Dashboard</a>
                    <a href="{{ url_for('register_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                    <a href="{{ url_for('import_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
                    <a href="{{ url_for('setting_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</a>
                    <hr class="my-1 border-slate-100">
                    <a href="/logout"
                        class="block px-4 py-2 text-sm text-rose-600 font-bold hover:bg-rose-50 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                    
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow flex flex-col w-full p-2">
        <div
            class="bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col h-[calc(100vh-100px)] overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-indigo-50/30 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-xl shadow-inner">
                        ü§ñ</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-lg uppercase">IEP Smart Assistant</h2>
                        <p class="text-[10px] text-emerald-500 font-bold flex items-center uppercase">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full mr-1 animate-pulse"></span> Online (Gemini
                            2.0 Pro)
                        </p>
                    </div>
                </div>
                <button onclick="clearChat()"
                    class="text-xs text-slate-400 hover:text-rose-500 transition font-medium italic uppercase tracking-widest outline-none">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
            </div>

            <div id="chat-box" class="flex-grow overflow-y-auto p-8 space-y-6 bg-slate-50/50">
                <div class="flex flex-col items-start">
                    <div
                        class="bg-white border border-slate-200 p-5 rounded-3xl rounded-tl-none max-w-[70%] shadow-sm text-sm text-slate-700 leading-relaxed">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <strong>{{ session['displayname'] }}</strong> ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI IEP SmartAssistant
                        ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö?
                    </div>
                </div>
            </div>

            <div class="p-6 bg-white border-t border-slate-100">
                <div class="flex items-center space-x-4">
                    <input type="text" id="user-input" onkeypress="if(event.key === 'Enter') sendMessage()"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI..."
                        class="flex-grow border border-slate-200 rounded-2xl px-6 py-4 text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 transition-all shadow-sm">
                    <button onclick="sendMessage()"
                        class="bg-indigo-600 text-white p-4 rounded-2xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">üöÄ</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            appendMessage(message, 'user');
            userInput.value = '';
            const loadingId = 'loading-' + Date.now();
            appendLoading(loadingId);

            fetch('/ask_ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
                .then(res => res.json())
                .then(data => {
                    removeLoading(loadingId);
                    appendMessage(data.reply, 'ai');
                })
                .catch(() => {
                    removeLoading(loadingId);
                    appendMessage('AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏∑‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞', 'ai');
                });
        }

        function appendMessage(text, sender) {
            const wrapper = document.createElement('div');
            wrapper.className = sender === 'user' ? 'flex flex-col items-end' : 'flex flex-col items-start';
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user'
                ? 'bg-indigo-600 text-white p-4 rounded-3xl rounded-tr-none max-w-[75%] shadow-md text-sm leading-relaxed whitespace-pre-line'
                : 'bg-white border border-slate-200 p-4 rounded-3xl rounded-tl-none max-w-[75%] shadow-sm text-sm leading-relaxed text-slate-700 whitespace-pre-line';
            messageDiv.textContent = text;
            wrapper.appendChild(messageDiv);
            chatBox.appendChild(wrapper);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function appendLoading(id) {
            const loader = document.createElement('div');
            loader.id = id;
            loader.className = 'flex flex-col items-start';
            loader.innerHTML = `<div class="bg-slate-200/50 p-3 rounded-2xl animate-pulse text-[10px] font-bold text-slate-400 uppercase tracking-widest">AI Thinking...</div>`;
            chatBox.appendChild(loader);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function clearChat() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?')) chatBox.innerHTML = '';
        }

        function toggleDropdown() { document.getElementById('user-menu').classList.toggle('hidden'); }
        window.onclick = function (e) { if (!e.target.closest('.relative')) document.getElementById('user-menu').classList.add('hidden'); }
    </script>
</body>

</html>