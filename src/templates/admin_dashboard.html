<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - IEP Smart Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col font-sans">

    <nav class="bg-indigo-900 text-white shadow-lg mb-8 font-sans">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center text-sm font-medium">
            <div class="flex items-center space-x-10">
                <div class="font-bold text-xl uppercase italic tracking-tighter border-r border-indigo-700 pr-10">
                    IEP Smart Assistant
                </div>

                <div class="flex space-x-8">
                    <a href="{{ url_for('chatbot_page') }}"
                        class="{% if request.endpoint == 'chatbot_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">Chatbot
                        AI</a>

                    <a href="{{ url_for('student_list_page') }}"
                        class="{% if request.endpoint == 'student_list_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>

                    {% if session['permission'] == 'Admin' %}
                    <a href="{{ url_for('import_page') }}"
                        class="{% if request.endpoint == 'import_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>

                    <a href="{{ url_for('admin_dashboard') }}"
                        class="{% if request.endpoint == 'admin_dashboard' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">Dashboard</a>

                    <a href="{{ url_for('register_page') }}"
                        class="{% if request.endpoint == 'register_page' %}border-b-2 border-white pb-1{% else %}hover:text-indigo-300 transition{% endif %}">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                    {% endif %}
                </div>
            </div>

            <div class="relative">
                <button onclick="toggleDropdown()"
                    class="bg-indigo-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition flex items-center shadow-md outline-none">
                    {{ session['displayname'] }} <span class="ml-2 text-[10px]">‚ñº</span>
                </button>
                <div id="user-menu"
                    class="absolute right-0 w-48 mt-2 py-2 bg-white rounded-xl shadow-xl hidden z-50 text-slate-700 border border-slate-100">
                    <a href="{{ url_for('setting_page') }}" class="block px-4 py-2 hover:bg-indigo-50 transition">‚öôÔ∏è
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</a>
                    <hr class="my-1 border-slate-100">
                    <a href="/logout"
                        class="block px-4 py-2 text-sm text-rose-600 font-bold hover:bg-rose-50 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-8 w-full">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>

            <div class="flex space-x-3">
                <button id="save-all-btn" onclick="saveAllChanges()"
                    class="hidden bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-emerald-600 active:scale-95 transition-all">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>

                <button onclick="toggleEditMode()"
                    class="bg-amber-500 text-white px-6 py-2 rounded-xl font-bold shadow hover:bg-amber-600 active:scale-95 transition-all">
                    üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
            </div>
        </div>

        <div class="space-y-4">
            {% for user in users %}
            <div class="flex items-center justify-between p-6 bg-white rounded-3xl shadow-sm border border-slate-100">
                <div class="flex items-center space-x-4 font-bold text-slate-700">
                    <span>{{ loop.index }}.</span>
                    <div class="flex items-center space-x-3">
                        <div class="view-mode flex items-center space-x-2">
                            <span class="text-lg">{{ user.displayname }}</span>
                            <span class="text-slate-400 font-normal text-sm">({{ user.username }})</span>
                            <span
                                class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-md uppercase font-extrabold border border-slate-200">{{
                                user.permission }}</span>
                        </div>

                        <div class="edit-mode hidden flex items-center space-x-3">
                            <input data-username="{{ user.username }}" value="{{ user.displayname }}"
                                class="display-input border border-slate-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 w-64">

                            {% set is_locked = (user.username == 'admin' or user.username == session['username']) %}
                            <select data-username="{{ user.username }}"
                                class="perm-input border border-slate-300 rounded-lg px-3 py-1.5 text-sm font-bold {% if is_locked %}bg-slate-200 text-slate-400{% endif %}"
                                {% if is_locked %}disabled{% endif %}>
                                <option value="Admin" {% if user.permission=='Admin' %}selected{% endif %}>Admin
                                </option>
                                <option value="User" {% if user.permission=='User' %}selected{% endif %}>User</option>
                            </select>

                            {% if not is_locked %}
                            <button onclick="deleteUser('{{ user.username }}')"
                                class="bg-rose-50 text-rose-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-rose-600 hover:text-white transition">‡∏•‡∏ö</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleEditMode() {
            document.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden'));
            document.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden'));
            document.getElementById('save-all-btn').classList.toggle('hidden');
        }

        async function saveAllChanges() {
            const inputs = document.querySelectorAll('.display-input');
            const selects = document.querySelectorAll('.perm-input');
            let successCount = 0;

            for (let i = 0; i < inputs.length; i++) {
                const username = inputs[i].getAttribute('data-username');
                const displayname = inputs[i].value;
                const permission = selects[i].value;

                try {
                    const response = await fetch('/update_user/' + username, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ displayname: displayname, permission: permission })
                    });
                    const data = await response.json();
                    if (data.success) successCount++;
                } catch (err) { console.error(err); }
            }

            if (successCount > 0) {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ' + successCount + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö!');
                location.reload();
            }
        }

        function deleteUser(username) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ' + username + '?')) {
                fetch('/delete_user/' + username, { method: 'POST' })
                    .then(res => res.json()).then(data => {
                        if (data.success) location.reload();
                        else alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πâ‡∏≤!');
                    });
            }
        }
        function toggleDropdown() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }

        window.onclick = function (event) {
            if (!event.target.closest('.relative')) {
                const menu = document.getElementById('user-menu');
                if (menu && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            }
        }
    </script>
</body>

</html>